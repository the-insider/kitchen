name: CI

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - '**'
  workflow_call:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.0'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Run RuboCop
        run: bundle exec rubocop

      - name: Check Gemfile
        run: bundle check

  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: kitchen_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.0'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Setup database
        env:
          DATABASE_HOST: localhost
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
          RAILS_ENV: test
        run: |
          bin/rails db:create
          bin/rails db:schema:load
          bin/rails db:migrate

      - name: Check for pending migrations
        env:
          DATABASE_HOST: localhost
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
          RAILS_ENV: test
        run: |
          bin/rails db:schema:dump

          # If schema.rb changed, it means there were migrations not committed
          if ! git diff --exit-code --quiet db/schema.rb; then
            echo "❌ ERROR: Pending migrations detected!"
            echo ""
            echo "The schema.rb file is out of sync with the migrations."
            echo "This means there are migrations in the codebase that haven't been committed."
            echo ""
            echo "To fix this:"
            echo "1. Run: bin/rails db:migrate (in development environment)"
            echo "2. Commit the updated db/schema.rb file"
            echo ""
            echo "Schema differences:"
            git diff db/schema.rb
            exit 1
          fi

          echo "✅ Schema is up to date - no pending migrations"

      - name: Run tests
        env:
          DATABASE_HOST: localhost
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
          RAILS_ENV: test
        run: bundle exec rspec

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
