name: PR Deploy

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  ci:
    name: Run CI
    uses: ./.github/workflows/ci.yml

  setup:
    name: Setup
    outputs:
      branch: ${{ steps.branch_name.outputs.current_branch }}
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8

  create_neon_branch:
    name: Create Neon Branch
    runs-on: ubuntu-latest
    needs: [ci, setup]
    if: |
      github.event_name == 'pull_request' && (
      github.event.action == 'synchronize'
      || github.event.action == 'opened'
      || github.event.action == 'reopened')
    outputs:
      db_url: ${{ steps.create_neon_branch_encode.outputs.db_url }}
      db_url_with_pooler: ${{ steps.create_neon_branch_encode.outputs.db_url_with_pooler }}
    environment: devspace
    steps:
      - name: Get branch expiration date as an env variable (2 weeks from now)
        id: get_expiration_date
        run: echo "EXPIRES_AT=$(date -u --date '+14 days' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      - name: Create Neon Branch
        id: create_neon_branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}
          expires_at: ${{ env.EXPIRES_AT }}
          database: ${{ vars.DATABASE_NAME }}
          role: ${{ secrets.DATABASE_USERNAME }}

  deploy-qa:
    name: Deploy PR
    needs: [create_neon_branch]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && (
      github.event.action == 'synchronize'
      || github.event.action == 'opened'
      || github.event.action == 'reopened')
    environment:
      name: devspace
      url: https://${{ github.event.repository.name }}-${{ needs.setup.outputs.branch }}.fly.dev
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Launch new app
        id: deploy
        shell: bash
        run: |
          # Build --env arguments from vars (properly quoted)
          VARS_ARGS=$(echo "$ALL_VARS" | jq -r 'to_entries[] | "--env \(.key)=\(.value | @sh)"' | tr '\n' ' ')

          # Build --secret arguments from secrets
          # Filter out FLY_API_TOKEN as it may contain newlines and is already set as env var
          # Use xargs to properly handle arguments with spaces/newlines
          SECRET_ARGS=$(echo "$APP_SECRETS" | jq -r 'to_entries | map(select(.key != "FLY_API_TOKEN")) | .[] | "--secret \(.key)=\(.value | @sh)"' | xargs)

          # Launch preview app
          flyctl launch --name "$FLY_APP_NAME" --no-redis --no-db $VARS_ARGS $SECRET_ARGS --env BUILD_VERSION="${{ github.sha }}" --secret DATABASE_HOST="$DATABASE_HOST" --secret RAILS_MASTER_KEY="$RAILS_MASTER_KEY"
          DEPLOYMENT_URL="https://$FLY_APP_NAME.fly.dev"
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        env:
          ALL_VARS: ${{ toJSON(vars) }}
          APP_SECRETS: ${{ toJSON(secrets) }}
          DATABASE_URL: ${{ needs.create_neon_branch.outputs.db_url_with_pooler }}
          FLY_APP_NAME: ${{ github.event.repository.name }}-${{ needs.setup.outputs.branch }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

      - name: Comment PR with deployment URL
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## ðŸš€ Preview Deployment

            Your preview environment has been deployed!

            **Environment URL:** [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})
            **Database:** Connected to Neon preview branch

            ---
            *This preview environment will be automatically destroyed when the PR is closed.*

  destory_devspace:
    name: Destory Preview Environment
    needs: setup
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Destroy
        shell: bash
        run: |
          flyctl apps destroy $FLY_APP_NAME -y
        env:
          FLY_APP_NAME: ${{ vars.FLY_APP_NAME }}-${{ needs.setup.outputs.branch }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
